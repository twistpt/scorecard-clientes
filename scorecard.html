<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Scorecard de Clientes - Twist</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            text-align: center;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Cliente Cards */
        .cliente-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .cliente-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .cliente-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .cliente-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cliente-nome {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .cliente-score {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 25px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .score-alto { color: #22c55e; }
        .score-medio { color: #f59e0b; }
        .score-baixo { color: #ef4444; }

        /* Input Groups */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group input, .input-group select {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Criterio Types */
        .criterio-tipo {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .tipo-escala { background: #dbeafe; color: #1d4ed8; }
        .tipo-inverso { background: #fef3c7; color: #d97706; }
        .tipo-binario { background: #dcfce7; color: #16a34a; }
        .tipo-progresso { background: #f3e8ff; color: #9333ea; }

        /* Scoring Interface */
        .scoring-grid {
            display: grid;
            gap: 20px;
        }

        .criterio-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid transparent;
        }

        .criterio-item.focus {
            border-color: #667eea;
        }

        .criterio-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .criterio-nome {
            font-weight: 600;
            color: #374151;
        }

        .criterio-peso {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* Sliders and Inputs */
        .slider-container {
            margin: 15px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 32px;
            background: #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .switch.active {
            background: #22c55e;
        }

        .switch-thumb {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .switch.active .switch-thumb {
            transform: translateX(28px);
        }

        .progress-input {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #22c55e);
            transition: width 0.3s;
            border-radius: 6px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-bottom: 5px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .cliente-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Histórico específico */
        .historico-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .mes-selector {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
        }

        .historico-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .historico-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #374151;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .meta-progress {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .criterios-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
        }

        .criterio-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .criterio-checkbox:hover {
            background: #f3f4f6;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .checkbox.checked {
            background: #667eea;
            border-color: #667eea;
        }

        .checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 2px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>📊 Scorecard de Clientes</h1>
                <p>Sistema de Avaliação de Performance - Twist</p>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('painel')">📈 Painel</button>
                <button class="tab" onclick="showTab('clientes')">👥 Clientes</button>
                <button class="tab" onclick="showTab('historico')">📅 Histórico</button>
                <button class="tab" onclick="showTab('criterios')">⚙️ Critérios</button>
            </div>

            <!-- PAINEL -->
            <div id="painel" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-clientes">0</div>
                        <div class="stat-label">Total de Clientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="score-medio">0</div>
                        <div class="stat-label">Score Médio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="clientes-alto">0</div>
                        <div class="stat-label">Performance Alta (7+)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="mes-atual">-</div>
                        <div class="stat-label">Mês Atual</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="card" style="margin: 0;">
                        <h3 style="margin-bottom: 15px;">🏆 Top 3 Clientes</h3>
                        <div id="top-clientes"></div>
                    </div>
                    <div class="card" style="margin: 0;">
                        <h3 style="margin-bottom: 15px;">⚠️ Necessitam Atenção</h3>
                        <div id="bottom-clientes"></div>
                    </div>
                </div>

                <div class="card" style="margin: 0;">
                    <h3 style="margin-bottom: 15px;">📊 Distribuição de Scores</h3>
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="clientes" class="tab-content">
                <div class="input-group">
                    <input type="text" id="novo-cliente" placeholder="Nome do novo cliente">
                    <button class="btn btn-primary" onclick="showAddClienteModal()">+ Adicionar Cliente</button>
                    <button class="btn btn-secondary" onclick="showMassAddModal()">📋 Adicionar Vários</button>
                </div>

                <div id="lista-clientes" class="cliente-grid"></div>
            </div>

            <!-- HISTÓRICO -->
            <div id="historico" class="tab-content">
                <div class="historico-controls">
                    <select id="historico-ano" class="mes-selector">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <select id="historico-mes" class="mes-selector">
                        <option value="01">Janeiro</option>
                        <option value="02">Fevereiro</option>
                        <option value="03">Março</option>
                        <option value="04">Abril</option>
                        <option value="05">Maio</option>
                        <option value="06">Junho</option>
                        <option value="07">Julho</option>
                        <option value="08">Agosto</option>
                        <option value="09" selected>Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                    <button class="btn btn-primary" onclick="atualizarHistorico()">🔄 Atualizar</button>
                </div>

                <div class="historico-section">
                    <h3 class="historico-title">📈 Evolução dos Clientes</h3>
                    <div class="chart-container">
                        <canvas id="evolucaoChart"></canvas>
                    </div>
                </div>

                <div class="historico-section">
                    <h3 class="historico-title">📊 Comparação Mensal</h3>
                    <div id="comparacao-mensal"></div>
                </div>

                <div class="historico-section">
                    <h3 class="historico-title">🎯 Metas Anuais</h3>
                    <div class="input-group">
                        <select id="meta-cliente">
                            <option value="">Selecionar cliente</option>
                        </select>
                        <input type="number" id="meta-valor" placeholder="Score alvo" min="0" max="10" step="0.1">
                        <button class="btn btn-primary" onclick="adicionarMeta()">📌 Adicionar Meta</button>
                    </div>
                    <div id="metas-lista"></div>
                </div>

                <div class="historico-section">
                    <h3 class="historico-title">📋 Relatórios</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportarRelatorio('completo')">📊 Relatório Completo</button>
                        <button class="btn btn-secondary" onclick="exportarRelatorio('csv')">📈 Exportar CSV</button>
                        <button class="btn btn-secondary" onclick="exportarRelatorio('executivo')">🎯 Resumo Executivo</button>
                        <button class="btn btn-secondary" onclick="exportarRelatorio('tendencias')">📉 Análise Tendências</button>
                    </div>
                </div>
            </div>

            <!-- CRITÉRIOS -->
            <div id="criterios" class="tab-content">
                <div class="input-group">
                    <input type="text" id="novo-criterio-nome" placeholder="Nome do critério">
                    <input type="number" id="novo-criterio-peso" placeholder="Peso" min="1" max="10" value="5">
                    <select id="novo-criterio-tipo">
                        <option value="escala">📊 Escala 0-10 (Normal)</option>
                        <option value="inverso">🔄 Escala 0-10 (Inverso)</option>
                        <option value="progresso">🎯 Meta vs Realizado (%)</option>
                        <option value="binario">✅ Sim/Não</option>
                    </select>
                    <button class="btn btn-primary" onclick="adicionarCriterio()">+ Adicionar</button>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">📝 Tipos de Critérios:</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px;">
                        <div style="padding: 15px; background: #dbeafe; border-radius: 10px;">
                            <h4>📊 Escala Normal</h4>
                            <p style="font-size: 0.9rem; margin-top: 5px;">Valor de 0 a 10. Maior = melhor</p>
                        </div>
                        <div style="padding: 15px; background: #fef3c7; border-radius: 10px;">
                            <h4>🔄 Escala Inversa</h4>
                            <p style="font-size: 0.9rem; margin-top: 5px;">Valor de 0 a 10. Maior = pior</p>
                        </div>
                        <div style="padding: 15px; background: #f3e8ff; border-radius: 10px;">
                            <h4>🎯 Meta vs Realizado</h4>
                            <p style="font-size: 0.9rem; margin-top: 5px;">Progresso 0-100%. Ex: 6/9 posts = 67%</p>
                        </div>
                        <div style="padding: 15px; background: #dcfce7; border-radius: 10px;">
                            <h4>✅ Sim/Não</h4>
                            <p style="font-size: 0.9rem; margin-top: 5px;">Para critérios binários. Sim=10, Não=0</p>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Critério</th>
                                <th>Tipo</th>
                                <th>Peso</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-criterios"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Import/Export -->
        <div class="card">
            <h3 style="margin-bottom: 15px;">💾 Backup & Restauro</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="exportarDados()">📥 Exportar Dados</button>
                <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">📤 Importar Dados</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importarDados(event)">
                <button class="btn btn-danger" onclick="if(confirm('⚠️ Isto vai apagar TODOS os dados. Confirma?')) resetarDados()">🗑️ Reset Completo</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- Modal Adicionar Cliente -->
    <div id="addClienteModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">👤 Adicionar Novo Cliente</h3>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nome do Cliente:</label>
                <input type="text" id="modal-cliente-nome" placeholder="Ex: 🏢 Empresa XYZ" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">Critérios Aplicáveis:</label>
                <div id="criterios-checkboxes" class="criterios-list"></div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeAddClienteModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="adicionarClienteComCriterios()">Adicionar Cliente</button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Vários -->
    <div id="massAddModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">📋 Adicionar Vários Clientes</h3>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Lista de Clientes (um por linha):</label>
                <textarea id="mass-clientes" rows="10" placeholder="🏢 Cliente A&#10;🚀 Cliente B&#10;💎 Cliente C&#10;🎯 Cliente D" style="width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 10px; resize: vertical;"></textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">Critérios para Todos:</label>
                <div id="mass-criterios-checkboxes" class="criterios-list"></div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeMassAddModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="adicionarClientesEmMassa()">Adicionar Todos</button>
            </div>
        </div>
    </div>

    <!-- Modal Scoring -->
    <div id="scoringModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h3 id="scoring-titulo" style="margin-bottom: 20px;"></h3>
            <div id="scoring-content"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeScoringModal()">Fechar</button>
                <button class="btn btn-primary" onclick="salvarScoring()">💾 Salvar Avaliação</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DADOS E CONFIGURAÇÃO =====
        let criteria = [
            { id: "redes_atualizadas", nome: "Todas as redes contratadas estão atualizadas?", peso: 8, tipo: "binario" },
            { id: "variedade_conteudo", nome: "Temos variedade de publicações foto/vídeo?", peso: 7, tipo: "binario" },
            { id: "frequencia_acordada", nome: "Publicamos nas rede com a frequência acordada?", peso: 10, tipo: "binario" },
            { id: "fotos_capa_perfil", nome: "Fotos de Capa/Perfil estão atualizadas?", peso: 6, tipo: "binario" },
            { id: "surpresa_cliente", nome: "Temos surpreendido ou planeamos surpreender o cliente?", peso: 9, tipo: "binario" },
            { id: "comunicacao_twist", nome: "O cliente tem atividade na comunicação com a Twist?", peso: 8, tipo: "binario" },
            { id: "frequencia_stories", nome: "Publicamos stories com frequência?", peso: 8, tipo: "progresso" },
            { id: "frequencia_posts", nome: "Publicamos posts com frequência?", peso: 9, tipo: "progresso" },
            { id: "cliente_distante", nome: "O cliente é distante do seu marketing?", peso: 7, tipo: "inverso" },
            { id: "relatorios_partilhados", nome: "Os relatórios foram partilhados com o cliente?", peso: 8, tipo: "binario" },
            { id: "interacao_plataformas", nome: "O cliente tem tido interação/envolvimento nas variadas plataformas?", peso: 7, tipo: "progresso" },
            { id: "satisfacao_servicos", nome: "Como achas que está o índice de satisfação do cliente com os nossos serviços?", peso: 10, tipo: "escala" },
            { id: "pagamento_pontual", nome: "O cliente paga pontualmente?", peso: 9, tipo: "binario" },
            { id: "anuncios_correr", nome: "Os anúncios estão a correr?", peso: 8, tipo: "binario" }
        ];

        let clientes = [];
        let registos = {}; // { "2025-09": { "cliente1": { "criterio1": 8, "criterio2": 5 } } }
        let metas = {}; // { "cliente1": 8.5 }

        let currentScoringCliente = null;
        let scoreChart = null;
        let evolucaoChart = null;

        // ===== FUNÇÕES AUXILIARES =====
        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        function salvarDados() {
            localStorage.setItem('scorecard-data', JSON.stringify({
                criteria,
                clientes,
                registos,
                metas
            }));
        }

        function carregarDados() {
            const data = localStorage.getItem('scorecard-data');
            if (data) {
                const parsed = JSON.parse(data);
                criteria = parsed.criteria || criteria;
                clientes = parsed.clientes || [];
                registos = parsed.registos || {};
                metas = parsed.metas || {};
            }
        }

        // ===== CÁLCULO DE SCORES =====
        function calcularScore(clienteId, mesEspecifico = null) {
            const mes = mesEspecifico || getCurrentMonth();
            const clienteRegistos = registos[mes]?.[clienteId];
            if (!clienteRegistos) return 0;

            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return 0;

            let somaNotas = 0;
            let somaPesos = 0;

            cliente.criteriosAplicaveis.forEach(criterioId => {
                const criterio = criteria.find(c => c.id === criterioId);
                const nota = clienteRegistos[criterioId];
                
                if (criterio && nota !== undefined && nota !== null) {
                    let notaFinal = nota;
                    
                    // Aplicar lógica por tipo
                    if (criterio.tipo === 'inverso') {
                        notaFinal = 10 - nota; // Inverter a nota
                    } else if (criterio.tipo === 'binario') {
                        notaFinal = nota; // Já vem como 0 ou 10
                    } else if (criterio.tipo === 'progresso') {
                        notaFinal = (nota / 100) * 10; // Converter % para 0-10
                    }
                    
                    somaNotas += notaFinal * criterio.peso;
                    somaPesos += criterio.peso;
                }
            });

            return somaPesos > 0 ? somaNotas / somaPesos : 0;
        }

        function getScoreClass(score) {
            if (score >= 7) return 'score-alto';
            if (score >= 4) return 'score-medio';
            return 'score-baixo';
        }

        // ===== GESTÃO DE CLIENTES =====
        function showAddClienteModal() {
            document.getElementById('modal-cliente-nome').value = '';
            atualizarCriteriosCheckboxes('criterios-checkboxes');
            document.getElementById('addClienteModal').classList.add('active');
        }

        function closeAddClienteModal() {
            document.getElementById('addClienteModal').classList.remove('active');
        }

        function showMassAddModal() {
            document.getElementById('mass-clientes').value = '';
            atualizarCriteriosCheckboxes('mass-criterios-checkboxes');
            document.getElementById('massAddModal').classList.add('active');
        }

        function closeMassAddModal() {
            document.getElementById('massAddModal').classList.remove('active');
        }

        function atualizarCriteriosCheckboxes(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            criteria.forEach(criterio => {
                const div = document.createElement('div');
                div.className = 'criterio-checkbox';
                div.innerHTML = `
                    <div class="checkbox checked" data-criterio="${criterio.id}"></div>
                    <span>${criterio.nome}</span>
                    <span class="criterio-tipo tipo-${criterio.tipo}">${getTipoLabel(criterio.tipo)}</span>
                `;
                
                div.querySelector('.checkbox').addEventListener('click', function() {
                    this.classList.toggle('checked');
                });
                
                container.appendChild(div);
            });
        }

        function getTipoLabel(tipo) {
            const labels = {
                'escala': '📊 Escala',
                'inverso': '🔄 Inverso',
                'progresso': '🎯 Meta',
                'binario': '✅ Sim/Não'
            };
            return labels[tipo] || tipo;
        }

        function adicionarClienteComCriterios() {
            const nome = document.getElementById('modal-cliente-nome').value.trim();
            if (!nome) {
                alert('Por favor, insira o nome do cliente');
                return;
            }

            const criteriosSelecionados = [];
            document.querySelectorAll('#criterios-checkboxes .checkbox.checked').forEach(checkbox => {
                criteriosSelecionados.push(checkbox.dataset.criterio);
            });

            if (criteriosSelecionados.length === 0) {
                alert('Por favor, selecione pelo menos um critério');
                return;
            }

            const novoCliente = {
                id: 'c' + Date.now(),
                nome: nome,
                criteriosAplicaveis: criteriosSelecionados
            };

            clientes.push(novoCliente);
            salvarDados();
            atualizarListaClientes();
            atualizarPainel();
            closeAddClienteModal();
        }

        function adicionarClientesEmMassa() {
            const texto = document.getElementById('mass-clientes').value.trim();
            if (!texto) {
                alert('Por favor, insira a lista de clientes');
                return;
            }

            const criteriosSelecionados = [];
            document.querySelectorAll('#mass-criterios-checkboxes .checkbox.checked').forEach(checkbox => {
                criteriosSelecionados.push(checkbox.dataset.criterio);
            });

            if (criteriosSelecionados.length === 0) {
                alert('Por favor, selecione pelo menos um critério');
                return;
            }

            const nomes = texto.split('\n').filter(nome => nome.trim());
            let adicionados = 0;

            nomes.forEach(nome => {
                const nomeFormatado = nome.trim();
                if (nomeFormatado) {
                    const novoCliente = {
                        id: 'c' + Date.now() + '_' + adicionados,
                        nome: nomeFormatado,
                        criteriosAplicaveis: [...criteriosSelecionados]
                    };
                    clientes.push(novoCliente);
                    adicionados++;
                }
            });

            salvarDados();
            atualizarListaClientes();
            atualizarPainel();
            closeMassAddModal();
            alert(`✅ ${adicionados} clientes adicionados com sucesso!`);
        }

        function removerCliente(clienteId) {
            if (confirm('Tem certeza que deseja remover este cliente?')) {
                clientes = clientes.filter(c => c.id !== clienteId);
                
                // Limpar registos do cliente
                Object.keys(registos).forEach(mes => {
                    if (registos[mes][clienteId]) {
                        delete registos[mes][clienteId];
                    }
                });
                
                // Limpar metas
                if (metas[clienteId]) {
                    delete metas[clienteId];
                }
                
                salvarDados();
                atualizarListaClientes();
                atualizarPainel();
            }
        }

        function showScoringModal(clienteId) {
            currentScoringCliente = clienteId;
            const cliente = clientes.find(c => c.id === clienteId);
            const mes = getCurrentMonth();
            
            document.getElementById('scoring-titulo').textContent = `📊 Avaliar: ${cliente.nome}`;
            
            const content = document.getElementById('scoring-content');
            content.innerHTML = '';
            
            cliente.criteriosAplicaveis.forEach(criterioId => {
                const criterio = criteria.find(c => c.id === criterioId);
                if (!criterio) return;
                
                const valorAtual = registos[mes]?.[clienteId]?.[criterioId] || (criterio.tipo === 'binario' ? 0 : (criterio.tipo === 'progresso' ? 0 : 5));
                
                const div = document.createElement('div');
                div.className = 'criterio-item';
                
                let inputHTML = '';
                let valorDisplay = '';
                
                if (criterio.tipo === 'binario') {
                    inputHTML = `
                        <div class="toggle-switch">
                            <div class="switch ${valorAtual === 10 ? 'active' : ''}" onclick="toggleBinario(this)" data-value="${valorAtual}">
                                <div class="switch-thumb"></div>
                            </div>
                            <span>${valorAtual === 10 ? 'Sim (10 pts)' : 'Não (0 pts)'}</span>
                        </div>
                    `;
                } else if (criterio.tipo === 'progresso') {
                    inputHTML = `
                        <div class="progress-input">
                            <input type="number" 
                                   value="${valorAtual}" 
                                   min="0" 
                                   max="100" 
                                   step="1"
                                   oninput="updateProgress(this)"
                                   style="width: 80px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 5px;">
                            <span>%</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${valorAtual}%"></div>
                            </div>
                            <span>${(valorAtual/100*10).toFixed(1)} pts</span>
                        </div>
                    `;
                } else {
                    // escala ou inverso
                    const displayValue = criterio.tipo === 'inverso' ? `${valorAtual} → ${10-valorAtual} pts` : `${valorAtual} pts`;
                    inputHTML = `
                        <div class="slider-container">
                            <input type="range" 
                                   class="slider" 
                                   min="0" 
                                   max="10" 
                                   step="0.5" 
                                   value="${valorAtual}"
                                   oninput="updateSlider(this)">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>0</span>
                                <span style="font-weight: bold;">${displayValue}</span>
                                <span>10</span>
                            </div>
                        </div>
                    `;
                }
                
                div.innerHTML = `
                    <div class="criterio-label">
                        <span class="criterio-nome">${criterio.nome}</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="criterio-tipo tipo-${criterio.tipo}">${getTipoLabel(criterio.tipo)}</span>
                            <span class="criterio-peso">Peso: ${criterio.peso}</span>
                        </div>
                    </div>
                    <input type="hidden" class="criterio-input" data-criterio="${criterioId}" value="${valorAtual}">
                    ${inputHTML}
                `;
                
                content.appendChild(div);
            });
            
            document.getElementById('scoringModal').classList.add('active');
        }

        function closeScoringModal() {
            document.getElementById('scoringModal').classList.remove('active');
            currentScoringCliente = null;
        }

        function toggleBinario(element) {
            const isActive = element.classList.contains('active');
            const newValue = isActive ? 0 : 10;
            
            element.classList.toggle('active');
            element.dataset.value = newValue;
            element.nextElementSibling.textContent = newValue === 10 ? 'Sim (10 pts)' : 'Não (0 pts)';
            
            // Atualizar input hidden
            const criterioInput = element.closest('.criterio-item').querySelector('.criterio-input');
            criterioInput.value = newValue;
        }

        function updateProgress(input) {
            const value = parseInt(input.value);
            const progressBar = input.parentElement.querySelector('.progress-fill');
            const pontos = input.parentElement.querySelector('span:last-child');
            
            progressBar.style.width = value + '%';
            pontos.textContent = (value/100*10).toFixed(1) + ' pts';
            
            // Atualizar input hidden
            const criterioInput = input.closest('.criterio-item').querySelector('.criterio-input');
            criterioInput.value = value;
        }

        function updateSlider(slider) {
            const value = parseFloat(slider.value);
            const criterio = criteria.find(c => c.id === slider.closest('.criterio-item').querySelector('.criterio-input').dataset.criterio);
            const displaySpan = slider.parentElement.querySelector('span:nth-child(2)');
            
            let displayText;
            if (criterio.tipo === 'inverso') {
                const pontosFinais = 10 - value;
                displayText = `${value} → ${pontosFinais} pts`;
            } else {
                displayText = `${value} pts`;
            }
            
            displaySpan.textContent = displayText;
            
            // Atualizar input hidden
            const criterioInput = slider.closest('.criterio-item').querySelector('.criterio-input');
            criterioInput.value = value;
        }

        function salvarScoring() {
            if (!currentScoringCliente) return;
            
            const mes = getCurrentMonth();
            if (!registos[mes]) registos[mes] = {};
            if (!registos[mes][currentScoringCliente]) registos[mes][currentScoringCliente] = {};
            
            document.querySelectorAll('#scoring-content .criterio-input').forEach(input => {
                const criterioId = input.dataset.criterio;
                const valor = parseFloat(input.value);
                registos[mes][currentScoringCliente][criterioId] = valor;
            });
            
            salvarDados();
            atualizarListaClientes();
            atualizarPainel();
            closeScoringModal();
            
            alert('✅ Avaliação salva com sucesso!');
        }

        // ===== ATUALIZAÇÃO DA INTERFACE =====
        function atualizarPainel() {
            const mes = getCurrentMonth();
            const mesData = registos[mes] || {};
            
            // Stats básicos
            document.getElementById('total-clientes').textContent = clientes.length;
            document.getElementById('mes-atual').textContent = new Date().toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
            
            // Calcular scores
            const scores = clientes.map(cliente => ({
                cliente,
                score: calcularScore(cliente.id, mes)
            })).filter(item => item.score > 0);
            
            const scoresMedio = scores.length > 0 ? scores.reduce((sum, item) => sum + item.score, 0) / scores.length : 0;
            document.getElementById('score-medio').textContent = scoresMedio.toFixed(1);
            
            const clientesAlto = scores.filter(item => item.score >= 7).length;
            document.getElementById('clientes-alto').textContent = clientesAlto;
            
            // Top 3 e Bottom 3
            const sortedByScore = [...scores].sort((a, b) => b.score - a.score);
            
            const topContainer = document.getElementById('top-clientes');
            topContainer.innerHTML = '';
            sortedByScore.slice(0, 3).forEach((item, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 10px; margin-bottom: 10px;';
                div.innerHTML = `
                    <span>${['🥇', '🥈', '🥉'][index]} ${item.cliente.nome}</span>
                    <span class="cliente-score ${getScoreClass(item.score)}">${item.score.toFixed(1)}</span>
                `;
                topContainer.appendChild(div);
            });
            
            const bottomContainer = document.getElementById('bottom-clientes');
            bottomContainer.innerHTML = '';
            sortedByScore.slice(-3).reverse().forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 10px; margin-bottom: 10px;';
                div.innerHTML = `
                    <span>⚠️ ${item.cliente.nome}</span>
                    <span class="cliente-score ${getScoreClass(item.score)}">${item.score.toFixed(1)}</span>
                `;
                bottomContainer.appendChild(div);
            });
            
            // Gráfico de distribuição
            atualizarGraficoDistribuicao(scores);
            
            // Atualizar seletor de metas
            const metaSelect = document.getElementById('meta-cliente');
            if (metaSelect) {
                metaSelect.innerHTML = '<option value="">Selecionar cliente</option>';
                clientes.forEach(cliente => {
                    metaSelect.innerHTML += `<option value="${cliente.id}">${cliente.nome}</option>`;
                });
            }
        }

        function atualizarGraficoDistribuicao(scores) {
            const ctx = document.getElementById('scoreChart');
            if (!ctx) return;
            
            const distribuicao = {
                'Baixo (0-4)': scores.filter(s => s.score < 4).length,
                'Médio (4-7)': scores.filter(s => s.score >= 4 && s.score < 7).length,
                'Alto (7-10)': scores.filter(s => s.score >= 7).length
            };
            
            if (scoreChart) {
                scoreChart.destroy();
            }
            
            scoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(distribuicao),
                    datasets: [{
                        label: 'Número de Clientes',
                        data: Object.values(distribuicao),
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'],
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function atualizarListaClientes() {
            const container = document.getElementById('lista-clientes');
            container.innerHTML = '';
            
            const mes = getCurrentMonth();
            
            clientes.forEach(cliente => {
                const score = calcularScore(cliente.id, mes);
                const temRegistos = registos[mes]?.[cliente.id] ? Object.keys(registos[mes][cliente.id]).length > 0 : false;
                
                const div = document.createElement('div');
                div.className = 'cliente-card';
                div.innerHTML = `
                    <div class="cliente-header">
                        <div>
                            <div class="cliente-nome">${cliente.nome}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; margin-top: 5px;">
                                ${cliente.criteriosAplicaveis.length} critérios aplicáveis
                            </div>
                        </div>
                        <div class="cliente-score ${getScoreClass(score)}">
                            ${score > 0 ? score.toFixed(1) : '-'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="showScoringModal('${cliente.id}')" style="flex: 1;">
                            ${temRegistos ? '📝 Editar' : '📊 Avaliar'}
                        </button>
                        <button class="btn btn-danger" onclick="removerCliente('${cliente.id}')">🗑️</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ===== CRITÉRIOS =====
        function adicionarCriterio() {
            const nome = document.getElementById('novo-criterio-nome').value.trim();
            const peso = parseInt(document.getElementById('novo-criterio-peso').value);
            const tipo = document.getElementById('novo-criterio-tipo').value;
            
            if (!nome) {
                alert('Por favor, insira o nome do critério');
                return;
            }
            
            if (!peso || peso < 1 || peso > 10) {
                alert('O peso deve ser entre 1 e 10');
                return;
            }
            
            const novoCriterio = {
                id: 'crit_' + Date.now(),
                nome,
                peso,
                tipo
            };
            
            criteria.push(novoCriterio);
            salvarDados();
            atualizarCriterios();
            
            // Limpar formulário
            document.getElementById('novo-criterio-nome').value = '';
            document.getElementById('novo-criterio-peso').value = '5';
            document.getElementById('novo-criterio-tipo').value = 'escala';
        }

        function removerCriterio(criterioId) {
            if (confirm('Tem certeza que deseja remover este critério?')) {
                criteria = criteria.filter(c => c.id !== criterioId);
                
                // Remover critério dos clientes
                clientes.forEach(cliente => {
                    cliente.criteriosAplicaveis = cliente.criteriosAplicaveis.filter(id => id !== criterioId);
                });
                
                // Remover dados históricos
                Object.keys(registos).forEach(mes => {
                    Object.keys(registos[mes]).forEach(clienteId => {
                        if (registos[mes][clienteId][criterioId]) {
                            delete registos[mes][clienteId][criterioId];
                        }
                    });
                });
                
                salvarDados();
                atualizarCriterios();
                atualizarListaClientes();
                atualizarPainel();
            }
        }

        function atualizarCriterios() {
            const tbody = document.getElementById('lista-criterios');
            tbody.innerHTML = '';
            
            criteria.forEach(criterio => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${criterio.nome}</td>
                    <td><span class="criterio-tipo tipo-${criterio.tipo}">${getTipoLabel(criterio.tipo)}</span></td>
                    <td>${criterio.peso}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removerCriterio('${criterio.id}')" style="padding: 8px 12px;">🗑️</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== HISTÓRICO =====
        function atualizarHistorico() {
            atualizarEvolucaoChart();
            atualizarComparacaoMensal();
            atualizarMetas();
        }

        function atualizarEvolucaoChart() {
            const ctx = document.getElementById('evolucaoChart');
            if (!ctx) return;
            
            if (evolucaoChart) {
                evolucaoChart.destroy();
            }
            
            const ano = document.getElementById('historico-ano').value;
            const meses = [];
            const datasets = [];
            
            // Gerar meses
            for (let m = 1; m <= 12; m++) {
                meses.push(`${String(m).padStart(2, '0')}`);
            }
            
            // Cores para clientes
            const cores = ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6', '#f97316', '#06b6d4', '#84cc16'];
            
            clientes.forEach((cliente, index) => {
                const dadosCliente = meses.map(mes => {
                    const chave = `${ano}-${mes}`;
                    return registos[chave] ? calcularScore(cliente.id, chave) : null;
                });
                
                datasets.push({
                    label: cliente.nome,
                    data: dadosCliente,
                    borderColor: cores[index % cores.length],
                    backgroundColor: cores[index % cores.length] + '20',
                    fill: false,
                    tension: 0.4,
                    spanGaps: true
                });
            });
            
            evolucaoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function atualizarComparacaoMensal() {
            const container = document.getElementById('comparacao-mensal');
            if (!container) return;
            
            const ano = document.getElementById('historico-ano').value;
            const mes = document.getElementById('historico-mes').value;
            const mesAtual = `${ano}-${mes}`;
            
            // Mês anterior
            let mesAnterior;
            if (mes === '01') {
                mesAnterior = `${parseInt(ano) - 1}-12`;
            } else {
                mesAnterior = `${ano}-${String(parseInt(mes) - 1).padStart(2, '0')}`;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Mês Anterior</th>
                                <th>Mês Atual</th>
                                <th>Diferença</th>
                                <th>Tendência</th>
                            </tr>
                        </thead>
                        <tbody id="comparacao-tbody"></tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('comparacao-tbody');
            
            clientes.forEach(cliente => {
                const scoreAtual = calcularScore(cliente.id, mesAtual);
                const scoreAnterior = calcularScore(cliente.id, mesAnterior);
                const diferenca = scoreAtual - scoreAnterior;
                
                let tendencia = '➡️ Estável';
                if (diferenca > 0.5) tendencia = '📈 Subindo';
                else if (diferenca < -0.5) tendencia = '📉 Descendo';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td class="${getScoreClass(scoreAnterior)}">${scoreAnterior > 0 ? scoreAnterior.toFixed(1) : '-'}</td>
                    <td class="${getScoreClass(scoreAtual)}">${scoreAtual > 0 ? scoreAtual.toFixed(1) : '-'}</td>
                    <td style="color: ${diferenca > 0 ? '#22c55e' : diferenca < 0 ? '#ef4444' : '#6b7280'}">
                        ${diferenca > 0 ? '+' : ''}${diferenca.toFixed(1)}
                    </td>
                    <td>${tendencia}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== METAS =====
        function adicionarMeta() {
            const clienteId = document.getElementById('meta-cliente').value;
            const valor = parseFloat(document.getElementById('meta-valor').value);
            
            if (!clienteId) {
                alert('Selecione um cliente');
                return;
            }
            
            if (!valor || valor < 0 || valor > 10) {
                alert('Insira um valor válido entre 0 e 10');
                return;
            }
            
            metas[clienteId] = valor;
            salvarDados();
            atualizarMetas();
            
            document.getElementById('meta-cliente').value = '';
            document.getElementById('meta-valor').value = '';
        }

        function removerMeta(clienteId) {
            delete metas[clienteId];
            salvarDados();
            atualizarMetas();
        }

        function atualizarMetas() {
            const container = document.getElementById('metas-lista');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(metas).forEach(clienteId => {
                const cliente = clientes.find(c => c.id === clienteId);
                if (!cliente) return;
                
                const meta = metas[clienteId];
                const scoreAtual = calcularScore(clienteId);
                const progresso = scoreAtual > 0 ? (scoreAtual / meta) * 100 : 0;
                
                let corProgresso = '#ef4444';
                if (progresso >= 90) corProgresso = '#22c55e';
                else if (progresso >= 70) corProgresso = '#f59e0b';
                
                const div = document.createElement('div');
                div.className = 'meta-item';
                div.innerHTML = `
                    <div style="min-width: 200px;">
                        <strong>${cliente.nome}</strong>
                        <div style="font-size: 0.9rem; color: #6b7280;">
                            Meta: ${meta} | Atual: ${scoreAtual.toFixed(1)}
                        </div>
                    </div>
                    <div class="meta-progress">
                        <div style="height: 100%; background: ${corProgresso}; width: ${Math.min(progresso, 100)}%; border-radius: 4px;"></div>
                    </div>
                    <div style="min-width: 80px; text-align: center;">
                        <strong>${progresso.toFixed(0)}%</strong>
                    </div>
                    <button class="btn btn-danger" onclick="removerMeta('${clienteId}')" style="padding: 5px 10px;">🗑️</button>
                `;
                container.appendChild(div);
            });
        }

        // ===== RELATÓRIOS =====
        function exportarRelatorio(tipo) {
            let dados, nomeArquivo;
            
            switch (tipo) {
                case 'completo':
                    dados = JSON.stringify({ criteria, clientes, registos, metas }, null, 2);
                    nomeArquivo = `scorecard-completo-${new Date().toISOString().split('T')[0]}.json`;
                    break;
                    
                case 'csv':
                    dados = gerarCSV();
                    nomeArquivo = `scorecard-dados-${new Date().toISOString().split('T')[0]}.csv`;
                    break;
                    
                case 'executivo':
                    dados = gerarResumoExecutivo();
                    nomeArquivo = `scorecard-executivo-${new Date().toISOString().split('T')[0]}.txt`;
                    break;
                    
                case 'tendencias':
                    dados = gerarAnaliseTendencias();
                    nomeArquivo = `scorecard-tendencias-${new Date().toISOString().split('T')[0]}.txt`;
                    break;
            }
            
            const blob = new Blob([dados], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nomeArquivo;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function gerarCSV() {
            let csv = 'Cliente,Mês,Score';
            criteria.forEach(c => csv += `,${c.nome}`);
            csv += '\n';
            
            Object.keys(registos).forEach(mes => {
                clientes.forEach(cliente => {
                    if (registos[mes][cliente.id]) {
                        csv += `${cliente.nome},${mes},${calcularScore(cliente.id, mes).toFixed(2)}`;
                        criteria.forEach(criterio => {
                            const valor = registos[mes][cliente.id][criterio.id];
                            csv += `,${valor !== undefined ? valor : ''}`;
                        });
                        csv += '\n';
                    }
                });
            });
            
            return csv;
        }

        function gerarResumoExecutivo() {
            const mes = getCurrentMonth();
            const scores = clientes.map(c => ({ nome: c.nome, score: calcularScore(c.id, mes) }))
                                  .filter(s => s.score > 0)
                                  .sort((a, b) => b.score - a.score);
            
            const scoreMedio = scores.reduce((sum, s) => sum + s.score, 0) / scores.length;
            const alto = scores.filter(s => s.score >= 7).length;
            const medio = scores.filter(s => s.score >= 4 && s.score < 7).length;
            const baixo = scores.filter(s => s.score < 4).length;
            
            return `📊 RESUMO EXECUTIVO - ${new Date().toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' })}

🎯 KPIs PRINCIPAIS:
• Total de Clientes: ${clientes.length}
• Score Médio: ${scoreMedio.toFixed(1)}/10
• Performance Alta (7+): ${alto} clientes (${(alto/clientes.length*100).toFixed(0)}%)
• Performance Média (4-7): ${medio} clientes (${(medio/clientes.length*100).toFixed(0)}%)
• Necessitam Atenção (<4): ${baixo} clientes (${(baixo/clientes.length*100).toFixed(0)}%)

🏆 TOP 3 CLIENTES:
${scores.slice(0, 3).map((s, i) => `${i+1}. ${s.nome} - ${s.score.toFixed(1)}/10`).join('\n')}

⚠️ PRIORIDADES:
${scores.slice(-3).reverse().map(s => `• ${s.nome} - ${s.score.toFixed(1)}/10`).join('\n')}

💡 RECOMENDAÇÕES:
• Focar nos ${baixo} clientes com performance baixa
• Replicar boas práticas dos top performers
• Aumentar frequência de acompanhamento
• Revisar critérios com peso alto`;
        }

        function gerarAnaliseTendencias() {
            // Implementação simplificada
            return `📈 ANÁLISE DE TENDÊNCIAS - ${new Date().toLocaleDateString('pt-PT')}

Esta funcionalidade será implementada com dados históricos de múltiplos meses.

Aguarde futuras atualizações! 🚀`;
        }

        // ===== IMPORT/EXPORT =====
        function exportarDados() {
            const dados = JSON.stringify({ criteria, clientes, registos, metas }, null, 2);
            const blob = new Blob([dados], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `scorecard-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function importarDados(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    if (dados.criteria && dados.clientes && dados.registos) {
                        criteria = dados.criteria;
                        clientes = dados.clientes;
                        registos = dados.registos;
                        metas = dados.metas || {};
                        salvarDados();
                        location.reload();
                    } else {
                        alert('Ficheiro inválido!');
                    }
                } catch (error) {
                    alert('Erro ao ler ficheiro!');
                }
            };
            reader.readAsText(file);
        }

        function resetarDados() {
            criteria = [
                { id: "redes_atualizadas", nome: "Todas as redes contratadas estão atualizadas?", peso: 8, tipo: "binario" },
                { id: "variedade_conteudo", nome: "Temos variedade de publicações foto/vídeo?", peso: 7, tipo: "binario" },
                { id: "frequencia_acordada", nome: "Publicamos nas rede com a frequência acordada?", peso: 10, tipo: "binario" },
                { id: "fotos_capa_perfil", nome: "Fotos de Capa/Perfil estão atualizadas?", peso: 6, tipo: "binario" },
                { id: "surpresa_cliente", nome: "Temos surpreendido ou planeamos surpreender o cliente?", peso: 9, tipo: "binario" },
                { id: "comunicacao_twist", nome: "O cliente tem atividade na comunicação com a Twist?", peso: 8, tipo: "binario" },
                { id: "frequencia_stories", nome: "Publicamos stories com frequência?", peso: 8, tipo: "progresso" },
                { id: "frequencia_posts", nome: "Publicamos posts com frequência?", peso: 9, tipo: "progresso" },
                { id: "cliente_distante", nome: "O cliente é distante do seu marketing?", peso: 7, tipo: "inverso" },
                { id: "relatorios_partilhados", nome: "Os relatórios foram partilhados com o cliente?", peso: 8, tipo: "binario" },
                { id: "interacao_plataformas", nome: "O cliente tem tido interação/envolvimento nas variadas plataformas?", peso: 7, tipo: "progresso" },
                { id: "satisfacao_servicos", nome: "Como achas que está o índice de satisfação do cliente com os nossos serviços?", peso: 10, tipo: "escala" },
                { id: "pagamento_pontual", nome: "O cliente paga pontualmente?", peso: 9, tipo: "binario" },
                { id: "anuncios_correr", nome: "Os anúncios estão a correr?", peso: 8, tipo: "binario" }
            ];
            clientes = [];
            registos = {};
            metas = {};
            localStorage.removeItem('scorecard-data');
            location.reload();
        }

        // ===== NAVEGAÇÃO TABS =====
        function showTab(tabName) {
            // Esconder todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Desativar todas as tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar o conteúdo selecionado
            document.getElementById(tabName).classList.add('active');
            
            // Ativar a tab selecionada
            event.target.classList.add('active');
            
            // Atualizar dados específicos da tab
            if (tabName === 'historico') {
                setTimeout(() => atualizarHistorico(), 100);
            }
        }

        // ===== INICIALIZAÇÃO =====
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            atualizarPainel();
            atualizarListaClientes();
            atualizarCriterios();
            
            // Event listeners
            document.getElementById('novo-cliente').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') showAddClienteModal();
            });
            
            document.getElementById('novo-criterio-nome').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') adicionarCriterio();
            });
            
            // Fechar modals ao clicar fora
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
